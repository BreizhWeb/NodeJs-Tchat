<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Client CHAT</title>
    <link href="./style.css" rel="stylesheet">
    <style type="text/css">
        input {
            outline: none;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="register">
            <h2>Chat IO</h2>
            <p>Register :</p>
            <div id="error"></div>
            <form id="rForm">
                <input type="text" size="35" id="rUsername" name="rUsername">
                mdp :
                <input type="password" size="35" id="rPassword" name="rPassword" style="outline:none;">
                confimer mdp :
                <input type="password" size="35" id="rPassword2" name="rPassword2" style="outline:none;">
                <input type="button" value="Register" id="rSubmit" disabled="true">
            </form>
            <p>Login : </p>
            <form id="lForm">
                <input type="text" size="35" id="lUsername" name="lUsername">
                <input type="password" size="35" id="lPassword" name="lPassword">
                <input type="button" value="Login" id="lSubmit" disabled="true">
            </form>
        </div>
        <div id="mainWrapper">
            <h2>ChatIO</h2>
            <div id="chatWrapper">
                <div id="chatWindow"></div>
                <form id="messageForm">
                    <input type="text" size="35" id="message" placeholder="Say something...">
                    <input type="submit" value="Submit">
                </form>
            </div>
        </div>

        <div id="userWrapper">
            <div id="users"></div>
        </div>
    </div>

    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script>

        $(function (){

            function getCookie(name) {
              const value = `; ${document.cookie}`;
              const parts = value.split(`; ${name}=`);
              if (parts.length === 2) return parts.pop().split(';').shift();
            }

            console.log(getCookie("token"));
            if (getCookie("tokenIv") != undefined && getCookie("tokenContent") != undefined) {
                hTokenIv = getCookie("tokenIv");
                hTokenContent = getCookie("tokenContent");
                $.post("./verifToken",
                {
                  tokenIv: hTokenIv,
                  tokenContent: hTokenContent
                },
                function(data,status){
                    if (status=="success") {
                        if (data.error != "true") {
                            window.location.href="./chat.html";
                        }
                    }
                });
            }

            var socket = io.connect();
            var $messageForm = $("#messageForm");
            var $message = $("#message");
            var $chat = $("#chatWindow");

            //round 2
            var $registerForm = $("#registerForm");
            var $users = $("#users");
            var $username = $("#username");
            var $password = $("#password");
            var $error = $("#error");

            var rPassword = document.getElementById("rPassword");
            var rPassword2 = document.getElementById("rPassword2");
            var rUsername = document.getElementById("rUsername");
            var rSubmit = document.getElementById("rSubmit");

            var lPassword = document.getElementById("lPassword");
            var lUsername = document.getElementById("lUsername");
            var lSubmit = document.getElementById("lSubmit");

            $("#rSubmit").click(function() {
                $.post("./register",
                {
                  username: rUsername.value,
                  password: rPassword.value
                },
                function(data,status){
                    if (status=="success") {
                        if (data.error == "true") {
                            alert("Votre username est déjà utilisé");
                        } else {
                            alert("Vous êtes bien inscrit "+data.username+", vous pouvez vous connecter <3");
                        }
                    }
                });
            });

            $("#lSubmit").click(function() {
                $.post("./login",
                {
                  username: lUsername.value,
                  password: lPassword.value
                },
                function(data,status){
                    if (status=="success") {
                        if (data.error == "true") {
                            alert("Vos identifiants ne correspondent pas");
                        } else {
                            alert("pas erreur");
                            window.location.href="./chat.html";
                        }
                    }
                });
            });

            function rCheck () {
                if (rPassword.value.length >= 8 && rPassword.value == rPassword2.value && rUsername.value.length >= 2) {
                    rSubmit.disabled = false;
                }
            }

            $("#rPassword2").keyup(function() {
                if (this.value != rPassword.value) {
                    rSubmit.disabled = true;
                    this.style.border = "1px solid red";
                } else {
                    this.style.border = "1px solid green";
                }
                rCheck();
            });

            $("#rPassword").keyup(function() {
                if (this.value.length < 8) {
                    rSubmit.disabled = true;
                    this.style.border = "1px solid red";
                } else {
                    this.style.border = "1px solid green";
                }
                if (rPassword2.value != rPassword.value) {
                    rSubmit.disabled = true;
                    rPassword2.style.border = "1px solid red";
                } else {
                    rPassword2.style.border = "1px solid green";
                }
                rCheck();
            });

            $("#rUsername").keyup(function() {
                if (this.value.length < 2) {
                    rSubmit.disabled = true;
                    this.style.border = "1px solid red";
                } else {
                    this.style.border = "1px solid green";
                }
                rCheck();
            });

            function lCheck () {
                if (lPassword.value.length >= 8 && lUsername.value.length >= 2) {
                    lSubmit.disabled = false;
                }
            }

            $("#lPassword").keyup(function() {
                if (this.value.length < 8) {
                    lSubmit.disabled = true;
                    this.style.border = "1px solid red";
                } else {
                    this.style.border = "1px solid green";
                }
                lCheck();
            });

            $("#lUsername").keyup(function() {
                if (this.value.length < 2) {
                    lSubmit.disabled = true;
                    this.style.border = "1px solid red";
                } else {
                    this.style.border = "1px solid green";
                }
                lCheck();
            });

            /*$messageForm.submit(function(e){
                e.preventDefault();
                console.log("Submittted..");
                socket.emit("send message",$message.val());
                $message.val("");
            });*/

            //round 2 add the username
            socket.on("new message",function(data){
                $chat.append("<strong>" + data.user + "</strong>: " + data.msg + "<br/>");
            });

            //round 2
            /*$registerForm.submit(function(e){
                e.preventDefault();
                socket.emit("registration",[$username.val(),$password.val()],function(data){
                    if(data){
                        $("#namesWrapper").hide();
                        $("#mainW;zrapper").show();
                        $("#userWrapper").show();
                    }else{
                        $error.html("Username is taken");
                    }
                });
                //$username.val("");
            });*/

            socket.on("usernames",function(data){
                let html = "";
                for (i=0;i<data.length;i++){
                    html += data[i] + "<br>";
                }
                $users.html(html);
            });

        });
    </script>
</body>
</html>
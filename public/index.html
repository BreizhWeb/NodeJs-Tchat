<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Client CHAT</title>
    <link href="./style.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="namesWrapper">
            <h2>Discord</h2>
            <p>Entrez votre prénom :</p>
            <div id="error"></div>
            <form id="usernameForm">
                <input type="text" size="35" id="username">
                <input type="submit" value="Envoyer">
            </form>
        </div>

        <div id="rooms">

        </div>


    </div>

    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script>
        $(function (){
            var socket =io.connect();
            var $messageForm = $("#messageForm");
            var $message = $("#message");
            var $chat = $("#chatWindow");
            let $rooms = $('#rooms');

            //round 2
            var $usernameForm = $("#usernameForm");
            var $users = $("#users");
            var $username = $("#username");
            var $error = $("#error");


            $messageForm.submit(function(e){
                e.preventDefault();
                console.log("Submittted..");
                socket.emit("send message",$message.val());
                $message.val("");
            });

            //round 2 add the username
            
            
            function newRoom(room){
            $rooms.append(`
                <div class="room" id="${room.id}">
                    <h2>${room.name}</h2>
                    <div class="userWrapper">
                        <div id="users"></div>
                    </div>
                    <div class="chatWrapper">
                        <div class="chatWindow"></div>
                        <form class="messageForm">
                            <input type="text" size="35" class="message" placeholder="Ecrivez ici">
                            <input type="submit" value="Envoyer">
                        </form>
                    </div>
                </div>
            `);
            return room.id;
        }

            //round 2
            $usernameForm.submit(function(e){
                e.preventDefault();
                socket.emit("new user",$username.val(),function(data){
                    if(data){
                        console.log(data);
                        data.forEach(room => {
                            let id = newRoom(room);
                            roomid = $('#' + room.id);
                            roomid.submit(function (e) {
                                e.preventDefault();
                                console.log(roomid.find('.chatWindow'));
                                socket.on("new message",function(data){
                                    roomid.find('.chatWindow')
                                    .append(" test <br/>");
                                });
                            });
                        });
                        $("#namesWrapper").hide();
                        $("#mainWrapper").show();
                        $("#userWrapper").show();

                    }else{
                        $error.html("Vous n'êtes pas autorisé, cassez vous !");
                    }
                });
                $username.val("");
            });

            socket.on("usernames",function(data){
                let html = "";
                for (i=0;i<data.length;i++){
                    html += data[i] + "<br>";
                }
                $users.html(html);
            });

        });

    </script>
</body>
</html>